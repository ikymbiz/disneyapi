<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>TDS 待ち時間デバッグ版</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background: #f4f4f4; }
        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 500px; margin: auto; }
        .ride { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
        .time { font-weight: bold; color: #d35400; }
        .error { color: red; font-size: 14px; background: #ffdada; padding: 10px; border-radius: 5px; }
        .loading { color: #666; font-style: italic; }
    </style>
</head>
<body>

<div class="card">
    <h2>TDS 待ち時間一覧</h2>
    <div id="status"></div>
    <div id="output">
        <p class="loading">データ読み込み中...（10秒以上かかる場合があります）</p>
    </div>
</div>

<script>
async function loadWaitTimes() {
    const statusEl = document.getElementById('status');
    const outputEl = document.getElementById('output');
    
    // 東京ディズニーシーのID
    const targetUrl = "https://queue-times.com/parks/275/queue_times.json";
    // 別のプロキシサーバーを使用
    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`;

    try {
        const response = await fetch(proxyUrl);
        if (!response.ok) throw new Error('ネットワーク応答が正常ではありません');
        
        const rawData = await response.json();
        // alloriginsは中身を文字列で返すのでパースが必要
        const data = JSON.parse(rawData.contents);
        
        let html = "";
        
        // データの取得先を判定（landsがあるか、直接ridesがあるか）
        let allRides = [];
        if (data.lands && data.lands.length > 0) {
            data.lands.forEach(land => {
                allRides = allRides.concat(land.rides);
            });
        } else if (data.rides) {
            allRides = data.rides;
        }

        if (allRides.length === 0) {
            outputEl.innerHTML = "<p>アトラクション情報が見つかりませんでした（閉園時間などの可能性あり）。</p>";
            return;
        }

        // 待ち時間順に並び替え
        allRides.sort((a, b) => b.wait_time - a.wait_time);

        allRides.forEach(ride => {
            const timeText = ride.is_open ? `${ride.wait_time}分` : "休止中";
            html += `
                <div class="ride">
                    <span>${ride.name}</span>
                    <span class="time">${timeText}</span>
                </div>
            `;
        });

        outputEl.innerHTML = html;
        statusEl.innerHTML = "<small>最終更新: " + new Date().toLocaleTimeString() + "</small>";

    } catch (error) {
        console.error("Error details:", error);
        outputEl.innerHTML = `
            <div class="error">
                <p><strong>取得に失敗しました</strong></p>
                <p>原因: ${error.message}</p>
                <p>※ブラウザのコンソール(F12)で詳細を確認してください。</p>
            </div>
        `;
    }
}

loadWaitTimes();
</script>
</body>
</html>
